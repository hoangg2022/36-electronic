<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông tin Người dùng - 36 Electronic Shop</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f0f4ff, #e6f0fa);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 120px;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            flex: 1;
        }
        h2 {
            text-align: center;
            color: #2c3e50;
            font-size: clamp(1.8rem, 4vw, 2.2rem);
            margin-bottom: 1.5rem;
        }
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .nav-tabs a {
            padding: 1rem 2rem;
            color: #2c3e50;
            text-decoration: none;
            font-weight: 500;
        }
        .nav-tabs a.active {
            background: #3498db;
            color: #fff;
            border-radius: 5px;
        }
        .tab-content {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%; /* Ensure tab content spans full container width */
        }
        .form-group {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            width: 100%; /* Ensure form group takes full width */
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .form-group input {
            width: 100%; /* Fix input width to span full container */
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff; /* Fix background color */
        }
        .form-group button {
            background: #3498db;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            align-self: flex-start; /* Align button to the start */
        }
        .form-group button:hover {
            background: #2980b9;
        }
        .order-table, .address-table {
            width: 100%; /* Ensure tables span full width */
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .order-table th, .order-table td, .address-table th, .address-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            word-wrap: break-word; /* Prevent text overflow */
        }
        .order-table th, .address-table th {
            background: #3498db;
            color: #fff;
        }
        .stats {
            margin-top: 1rem;
            font-size: 1.1rem;
            color: #2c3e50;
            width: 100%; /* Ensure stats span full width */
        }
        .address-actions button {
            background: #e74c3c;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        .address-actions button:hover {
            background: #c0392b;
        }
        @media (max-width: 768px) {
            body { padding-top: 80px; }
            .nav-tabs { flex-direction: column; }
            .nav-tabs a { padding: 0.5rem 1rem; }
            .order-table th, .order-table td, .address-table th, .address-table td {
                padding: 0.5rem; /* Reduce padding on smaller screens */
                font-size: 0.9rem; /* Adjust font size */
            }
        }
    </style>
</head>
<body>
    {% include 'header/header.html' %}
    <div class="container">
        <h2>Thông tin Người dùng</h2>
        <div class="nav-tabs">
            <a href="#account" class="active" onclick="showTab('account')">Thông tin tài khoản</a>
            <a href="#address" onclick="showTab('address')">Địa chỉ</a>
            <a href="#orders" onclick="showTab('orders')">Lịch sử đơn hàng</a>
            <a href="#membership" onclick="showTab('membership')">Hạng thành viên</a>
        </div>
        <div id="account" class="tab-content">
            <div class="form-group">
                <label>Tên người dùng:</label>
                <input type="text" id="username" readonly>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="email" readonly>
            </div>
            <div class="form-group">
                <label>Họ và tên:</label>
                <input type="text" id="full_name" readonly>
            </div>
            <div class="form-group">
                <label>Ngày sinh:</label>
                <input type="date" id="birth_date" readonly>
            </div>
        </div>
        <div id="address" class="tab-content" style="display:none;">
            <div class="form-group">
                <button onclick="addAddress()">Thêm địa chỉ</button>
            </div>
            <table class="address-table">
                <thead>
                    <tr>
                        <th>Địa chỉ</th>
                        <th>Thành phố</th>
                        <th>Mã bưu điện</th>
                        <th>Quốc gia</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="addressList"></tbody>
            </table>
        </div>
        <div id="orders" class="tab-content" style="display:none;">
            <table class="order-table">
                <thead>
                    <tr>
                        <th>Mã đơn</th>
                        <th>Ngày đặt</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="orderList"></tbody>
            </table>
            <div class="stats">
                Số lượng sản phẩm đã mua: <span id="purchasedCount">0</span><br>
                Số lượng sản phẩm trong giỏ hàng: <span id="cartCount">0</span>
            </div>
        </div>
        <div id="membership" class="tab-content" style="display:none;">
            <div class="stats">
                Hạng thành viên: <span id="membershipLevel">Chưa có</span><br>
                Tổng chi tiêu: <span id="totalSpent">0 VNĐ</span>
            </div>
        </div>
    </div>
    {% include '/footer/footer.html' %}
    <script>
        let currentTab = 'account';

        // Format number with dots every three digits
        function formatVND(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' VNĐ';
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.nav-tabs a').forEach(a => a.classList.remove('active'));
            document.querySelector(`.nav-tabs a[href="#${tabId}"]`).classList.add('active');
            currentTab = tabId;
            if (tabId === 'account') loadProfile();
            if (tabId === 'address') loadAddresses();
            if (tabId === 'orders') loadOrders();
            if (tabId === 'membership') loadMembership();
        }

        function loadProfile() {
            fetch('/api/user/profile')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const profile = data.data.user_info;
                        document.getElementById('username').value = profile.username;
                        document.getElementById('email').value = profile.email;
                        document.getElementById('full_name').value = profile.full_name;
                        document.getElementById('birth_date').value = profile.birth_date;
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Lỗi tải thông tin:', error);
                    Swal.fire('Lỗi', 'Không thể tải thông tin', 'error');
                });
        }

        function loadAddresses() {
            fetch('/api/user/addresses')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const addressList = document.getElementById('addressList');
                        addressList.innerHTML = '';
                        if (data.data.addresses.length === 0) {
                            addressList.innerHTML = '<tr><td colspan="5">Chưa có địa chỉ nào.</td></tr>';
                        } else {
                            data.data.addresses.forEach(address => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${address.address_line}</td>
                                    <td>${address.city}</td>
                                    <td>${address.postal_code || 'N/A'}</td>
                                    <td>${address.country}</td>
                                    <td class="address-actions">
                                        <button onclick="editAddress(${address.id}, '${address.address_line}', '${address.city}', '${address.postal_code || ''}', '${address.country}')">Sửa</button>
                                        <button onclick="deleteAddress(${address.id})">Xóa</button>
                                    </td>
                                `;
                                addressList.appendChild(row);
                            });
                        }
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Lỗi tải địa chỉ:', error);
                    Swal.fire('Lỗi', 'Không thể tải địa chỉ', 'error');
                });
        }

        function addAddress() {
            Swal.fire({
                title: 'Thêm địa chỉ mới',
                html: `
                    <input id="swal-address-line" class="swal2-input" placeholder="Địa chỉ" required>
                    <input id="swal-city" class="swal2-input" placeholder="Thành phố" required>
                    <input id="swal-postal-code" class="swal2-input" placeholder="Mã bưu điện">
                    <input id="swal-country" class="swal2-input" placeholder="Quốc gia" required>
                `,
                showCancelButton: true,
                confirmButtonText: 'Thêm',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const address_line = document.getElementById('swal-address-line').value;
                    const city = document.getElementById('swal-city').value;
                    const postal_code = document.getElementById('swal-postal-code').value;
                    const country = document.getElementById('swal-country').value;
                    if (!address_line || !city || !country) {
                        Swal.showValidationMessage('Vui lòng điền các trường bắt buộc');
                        return false;
                    }
                    return { address_line, city, postal_code, country };
                }
            }).then(result => {
                if (result.isConfirmed) {
                    fetch('/api/user/addresses/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(result.value)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Thành công', 'Địa chỉ đã được thêm', 'success').then(() => loadAddresses());
                            } else {
                                Swal.fire('Lỗi', data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Lỗi thêm địa chỉ:', error);
                            Swal.fire('Lỗi', 'Không thể thêm địa chỉ', 'error');
                        });
                }
            });
        }

        function editAddress(id, address_line, city, postal_code, country) {
            Swal.fire({
                title: 'Sửa địa chỉ',
                html: `
                    <input id="swal-address-line" class="swal2-input" value="${address_line}" placeholder="Địa chỉ" required>
                    <input id="swal-city" class="swal2-input" value="${city}" placeholder="Thành phố" required>
                    <input id="swal-postal-code" class="swal2-input" value="${postal_code}" placeholder="Mã bưu điện">
                    <input id="swal-country" class="swal2-input" value="${country}" placeholder="Quốc gia" required>
                `,
                showCancelButton: true,
                confirmButtonText: 'Cập nhật',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const address_line = document.getElementById('swal-address-line').value;
                    const city = document.getElementById('swal-city').value;
                    const postal_code = document.getElementById('swal-postal-code').value;
                    const country = document.getElementById('swal-country').value;
                    if (!address_line || !city || !country) {
                        Swal.showValidationMessage('Vui lòng điền các trường bắt buộc');
                        return false;
                    }
                    return { address_line, city, postal_code, country };
                }
            }).then(result => {
                if (result.isConfirmed) {
                    fetch(`/api/user/addresses/${id}/edit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(result.value)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Thành công', 'Địa chỉ đã được cập nhật', 'success').then(() => loadAddresses());
                            } else {
                                Swal.fire('Lỗi', data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Lỗi cập nhật địa chỉ:', error);
                            Swal.fire('Lỗi', 'Không thể cập nhật địa chỉ', 'error');
                        });
                }
            });
        }

        function deleteAddress(id) {
            Swal.fire({
                title: 'Xóa địa chỉ',
                text: 'Bạn có chắc muốn xóa địa chỉ này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then(result => {
                if (result.isConfirmed) {
                    fetch(`/api/user/addresses/${id}/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Thành công', 'Địa chỉ đã được xóa', 'success').then(() => loadAddresses());
                            } else {
                                Swal.fire('Lỗi', data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Lỗi xóa địa chỉ:', error);
                            Swal.fire('Lỗi', 'Không thể xóa địa chỉ', 'error');
                        });
                }
            });
        }

        function loadOrders() {
            fetch('/api/user/profile')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const orders = data.data.orders;
                        const orderList = document.getElementById('orderList');
                        orderList.innerHTML = '';
                        orders.forEach(order => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${order.order_id}</td>
                                <td>${order.date}</td>
                                <td>${formatVND(order.total_price)}</td>
                                <td>${order.status}</td>
                            `;
                            orderList.appendChild(row);
                        });
                        document.getElementById('purchasedCount').textContent = data.data.purchased_count;
                        document.getElementById('cartCount').textContent = data.data.cart_count;
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Lỗi tải đơn hàng:', error);
                    Swal.fire('Lỗi', 'Không thể tải đơn hàng', 'error');
                });
        }

        function loadMembership() {
            fetch('/api/user/profile')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const totalSpent = data.data.total_spent;
                        const membershipLevel = Math.floor(totalSpent / 10000000);
                        document.getElementById('membershipLevel').textContent = membershipLevel === 0 ? 'Chưa có' : `Hạng ${membershipLevel}`;
                        document.getElementById('totalSpent').textContent = formatVND(totalSpent);
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Lỗi tải hạng thành viên:', error);
                    Swal.fire('Lỗi', 'Không thể tải hạng thành viên', 'error');
                });
        }

        window.onload = () => {
            showTab('account');
            loadProfile();
        };
    </script>
</body>
</html>