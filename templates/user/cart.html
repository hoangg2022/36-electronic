<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - 36 Electronic Shop</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* CSS Reset and Basic Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f0f4ff, #e6f0fa);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 140px; /* Padding for desktop header */
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            flex: 1;
        }

        h2 {
            text-align: center;
            color: #2c3e50;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            margin-bottom: 2rem;
        }

        /* Cart Table Styling */
        .cart-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .cart-table thead {
            background: #3498db;
            color: #fff;
        }

        .cart-table th,
        .cart-table td {
            padding: 1rem 1.25rem;
            text-align: left;
            vertical-align: middle;
            border-bottom: 1px solid #e0e0e0;
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        .cart-table tbody tr:last-child td {
            border-bottom: none;
        }

        .cart-table img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            vertical-align: middle;
        }

        .cart-table input[type="number"] {
            width: 65px;
            padding: 0.6rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            text-align: center;
        }

        .cart-table input[type="checkbox"] {
            transform: scale(1.4);
            cursor: pointer;
            accent-color: #3498db;
        }

        .cart-table button {
            background: #e74c3c;
            color: #fff;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.3s ease;
        }

        .cart-table button:hover {
            background: #c0392b;
        }
        
        .product-info {
            display: flex;
            align-items: center;
        }
        
        .product-info img {
            margin-right: 15px;
        }

        /* Total and Checkout Section */
        .cart-summary {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
        }

        .total {
            font-size: clamp(1.1rem, 3vw, 1.4rem);
            margin-top: 20px;
            color: #2c3e50;
            font-weight: 700;
        }

        .checkout-btn {
            display: block;
            width: 100%;
            max-width: 250px;
            margin: 1rem auto;
            padding: 0.9rem;
            background: #2ecc71;
            color: #fff;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        }

        .checkout-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(46, 204, 113, 0.4);
        }

        .empty-cart {
            text-align: center;
            font-size: 1.2rem;
            color: #7f8c8d;
            padding: 3rem 1rem;
            background-color: #fff;
            border-radius: 8px;
        }

        /* Payment Modal Styles */
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .payment-modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .payment-modal h3 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #2c3e50;
        }

        .payment-modal input {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .payment-methods {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .payment-methods button {
            background: #3498db;
            color: #fff;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .payment-methods button:hover {
            background: #2980b9;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        /* Responsive Design */
        
        /* Tablet */
        @media (max-width: 992px) {
            .cart-table th,
            .cart-table td {
                padding: 0.8rem 1rem;
            }
        }
        
        /* Mobile */
        @media (max-width: 768px) {
            body {
                /* ĐÃ SỬA: Tăng padding để header không che nội dung */
                padding-top: 110px; 
            }

            h2 {
                margin-bottom: 1.5rem;
            }

            .cart-table {
                display: block;
                border-radius: 0;
                box-shadow: none;
                background: transparent;
            }

            .cart-table thead {
                display: none; /* Hide table headers */
            }

            .cart-table, .cart-table tbody, .cart-table tr, .cart-table td {
                display: block;
                width: 100%;
            }

            .cart-table tr {
                background: #fff;
                margin-bottom: 1rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                overflow: hidden;
            }
            
            .cart-table td {
                text-align: right; /* Align text to the right */
                padding-left: 50%; /* Create space for the label */
                position: relative;
                border-bottom: 1px solid #eee;
            }
            
            .cart-table td:last-child {
                 border-bottom: none;
            }

            .cart-table td::before {
                content: attr(data-label); /* Use data-label for pseudo-element content */
                position: absolute;
                left: 1rem;
                width: calc(50% - 2rem);
                text-align: left;
                font-weight: 600;
                color: #3498db;
            }

            .cart-table td[data-label="Hình ảnh"] {
                display: flex;
                justify-content: flex-end;
                align-items: center;
            }

            .cart-table input[type="number"] {
                width: 55px;
                padding: 0.5rem;
            }

            .cart-table button {
                padding: 0.5rem 0.8rem;
            }

            .cart-summary {
                align-items: center; /* Center summary items on mobile */
            }

            .checkout-btn {
                width: 90%;
            }
            
            .payment-methods {
                flex-direction: column;
            }

            .payment-modal-content {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    {% include 'header/header.html' %}
    <div class="container">
        <h2>Giỏ hàng của bạn</h2>
        <div id="cart-container">
            <table class="cart-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>Hình ảnh</th>
                        <th>Sản phẩm</th>
                        <th>Giá</th>
                        <th>Số lượng</th>
                        <th>Tổng</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="cartList">
                    </tbody>
            </table>
        </div>
        
        <div class="cart-summary">
            <div class="total" id="cartTotal">Tổng: 0 VNĐ</div>
        </div>

        <button class="checkout-btn" onclick="showPaymentModal()">Thanh toán</button>
    </div>

    <!-- Payment Modal -->
    <div class="payment-modal" id="paymentModal">
        <div class="payment-modal-content">
            <span class="close-modal" onclick="closePaymentModal()">&times;</span>
            <h3>Thông tin thanh toán</h3>
            <input type="text" id="shippingAddress" placeholder="Nhập địa chỉ nhận hàng" required>
            <input type="text" id="shippingPhone" placeholder="Nhập số điện thoại" required>
            
            <div class="payment-methods">
                <button onclick="checkout('online')">Thanh toán online</button>
                <button onclick="checkout('cod')">Thanh toán khi nhận hàng</button>
            </div>
        </div>
    </div>

    {% include '/footer/footer.html' %}
    <script>
        let cartItems = [];

        function renderCart() {
            const cartList = document.getElementById('cartList');
            const cartTotal = document.getElementById('cartTotal');
            const checkoutBtn = document.querySelector('.checkout-btn');
            const cartContainer = document.getElementById('cart-container');
            
            if (cartItems.length === 0) {
                 cartContainer.innerHTML = '<div class="empty-cart">Giỏ hàng của bạn đang trống!</div>';
                 cartTotal.textContent = 'Tổng: 0 VNĐ';
                 checkoutBtn.style.display = 'none';
            } else {
                 cartContainer.innerHTML = `
                    <table class="cart-table">
                         <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>Hình ảnh</th>
                                <th>Sản phẩm</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Tổng</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="cartListBody"></tbody>
                    </table>
                 `;
                 const newCartListBody = document.getElementById('cartListBody');
                 checkoutBtn.style.display = 'block';
                 let total = 0;
                 cartItems.forEach((item, index) => {
                     const itemTotal = item.price * item.quantity;
                     if (item.selected) total += itemTotal;
                     const row = document.createElement('tr');
                     // Using data-label attributes for mobile view
                     row.innerHTML = `
                         <td data-label="Chọn"><input type="checkbox" ${item.selected ? 'checked' : ''} onchange="toggleItem(${index})"></td>
                         <td data-label="Hình ảnh"><img src="${item.image_url}" alt="${item.name}"></td>
                         <td data-label="Sản phẩm">${item.name}</td>
                         <td data-label="Giá">${item.price.toLocaleString('vi-VN')} VNĐ</td>
                         <td data-label="Số lượng"><input type="number" min="1" value="${item.quantity}" onchange="updateQuantity(${index}, this.value)"></td>
                         <td data-label="Tổng">${itemTotal.toLocaleString('vi-VN')} VNĐ</td>
                         <td data-label="Hành động"><button onclick="removeFromCart(${item.product_id})"><i class="fas fa-trash"></i></button></td>
                     `;
                     newCartListBody.appendChild(row);
                 });
                 cartTotal.textContent = `Tổng: ${total.toLocaleString('vi-VN')} VNĐ`;
                 document.getElementById('selectAll').checked = cartItems.every(item => item.selected);
            }
        }

        function loadCart() {
            fetch('/api/cart')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        Swal.fire('Lỗi', data.message, 'error').then(() => {
                            window.location.href = '/login';
                        });
                        return;
                    }
                    const selectedState = cartItems.reduce((acc, item) => {
                        acc[item.product_id] = item.selected;
                        return acc;
                    }, {});

                    cartItems = data.items.map(item => ({
                        ...item,
                        selected: selectedState[item.product_id] || false
                    }));
                    renderCart();
                })
                .catch(error => {
                    console.error('Lỗi tải giỏ hàng:', error);
                    Swal.fire('Lỗi', 'Không thể tải giỏ hàng', 'error');
                });
        }

        function toggleItem(index) {
            cartItems[index].selected = !cartItems[index].selected;
            renderCart();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            cartItems.forEach(item => item.selected = selectAll);
            renderCart();
        }

        function updateQuantity(index, quantity) {
            const item = cartItems[index];
            const newQuantity = parseInt(quantity) || 1;
            fetch('/api/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_id: item.product_id,
                    quantity: newQuantity - item.quantity
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        loadCart();
                    } else {
                        Swal.fire('Lỗi', result.message, 'error');
                        loadCart(); // Re-render to show original quantity
                    }
                })
                .catch(error => {
                    console.error('Lỗi cập nhật số lượng:', error);
                    Swal.fire('Lỗi', 'Không thể cập nhật số lượng', 'error');
                });
        }

        function removeFromCart(productId) {
            fetch('/api/cart/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Thành công', data.message, 'success');
                        loadCart();
                    } else {
                        Swal.fire('Lỗi', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Lỗi xóa sản phẩm:', error);
                    Swal.fire('Lỗi', 'Không thể xóa sản phẩm', 'error');
                });
        }
        
        function showPaymentModal() {
    const selectedItems = cartItems.filter(item => item.selected);
    if (selectedItems.length === 0) {
        Swal.fire('Cảnh báo', 'Vui lòng chọn ít nhất một sản phẩm để thanh toán!', 'warning');
        return;
    }
    
    document.getElementById('paymentModal').style.display = 'flex';
}

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        function checkout(paymentMethod) {
            const selectedItems = cartItems.filter(item => item.selected);
            const address = document.getElementById('shippingAddress').value.trim();
            const phone = document.getElementById('shippingPhone').value.trim();

            // Validate phone number
            const phoneRegex = /^(09|03)\d{8}$/;
            if (!address || !phone) {
                Swal.fire('Thiếu thông tin', 'Vui lòng nhập đầy đủ địa chỉ và số điện thoại.', 'warning');
                return;
            }
            
            if (!phoneRegex.test(phone)) {
                Swal.fire('Số điện thoại không hợp lệ', 'Số điện thoại phải có 10 chữ số và bắt đầu bằng 09 hoặc 03.', 'warning');
                return;
            }
            
            if (paymentMethod === 'online') {
                Swal.fire('Chưa hỗ trợ', 'Hiện chúng tôi chưa hỗ trợ thanh toán online. Vui lòng chọn hình thức khác.', 'info');
                return;
            }
            
            if (paymentMethod === 'cod') {
                Swal.fire({
                    title: 'Xác nhận đặt hàng',
                    text: 'Bạn có chắc muốn đặt hàng và thanh toán khi nhận hàng?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy'
                }).then(result => {
                    if (result.isConfirmed) {
                        fetch('/api/cart/checkout', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                selected_items: selectedItems,
                                payment_method: 'cod',
                                address: address,
                                phone: phone
                            })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Thành công!', data.message, 'success').then(() => {
                                    closePaymentModal();
                                    loadCart();
                                });
                            } else {
                                Swal.fire('Lỗi', data.message || 'Không thể hoàn tất thanh toán.', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Lỗi khi thanh toán:', error);
                            Swal.fire('Lỗi', 'Có lỗi xảy ra trong quá trình thanh toán.', 'error');
                        });
                    }
                });
            }
        }
        
        function setupUserMenu() {
            // This function remains unchanged. Assuming it's working correctly.
            fetch('/api/check_login')
                .then(response => response.json())
                .then(data => {
                    const userMenu = document.getElementById('userMenu');
                    const userNameSpan = document.getElementById('userName');
                    const userDropdown = document.getElementById('userDropdown');
                    const logoutBtn = document.getElementById('logoutBtn');

                    if (data.logged_in && userNameSpan) {
                        userNameSpan.textContent = data.full_name;
                        if (userMenu) {
                            userMenu.onclick = () => {
                                userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                            };
                        }
                    } else if (userMenu && userNameSpan) {
                        userNameSpan.textContent = 'Đăng nhập';
                        if (userDropdown) userDropdown.style.display = 'none';
                        userMenu.onclick = () => window.location.href = '/login';
                    }

                    if (logoutBtn) {
                        logoutBtn.onclick = (e) => {
                            e.preventDefault();
                            fetch('/api/logout', { method: 'POST' })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        Swal.fire('Thành công', 'Đã đăng xuất!', 'success').then(() => {
                                            window.location.href = data.redirect;
                                        });
                                    }
                                })
                                .catch(error => {
                                    console.error('Lỗi đăng xuất:', error);
                                    Swal.fire('Lỗi', 'Không thể đăng xuất', 'error');
                                });
                        };
                    }
                })
                .catch(error => {
                    console.error('Lỗi kiểm tra đăng nhập:', error);
                });
        }

        window.onload = () => {
            loadCart();
            setupUserMenu();
        };

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target === modal) {
                closePaymentModal();
            }
        };
    </script>
</body>
</html>